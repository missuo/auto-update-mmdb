# Auto Update MMDB

Automatically update GeoLite2-Country MMDB and generate nftables IP sets for geolocation-based filtering.

## Features

- Fetches the latest GeoLite2-Country.mmdb from [P3TERX/GeoLite.mmdb](https://github.com/P3TERX/GeoLite.mmdb) releases
- Parses MMDB to extract China (CN) networks
- Generates nftables set files for IPv4 and IPv6
- Automatically reloads nftables configuration

## Installation

### Build from source

```bash
git clone https://github.com/missuo/auto-update-mmdb.git
cd auto-update-mmdb
go build -o /usr/local/bin/auto-update-mmdb
```

### Run manually

```bash
sudo /usr/local/bin/auto-update-mmdb
```

### Set up automatic updates with systemd

Create a systemd service file at `/etc/systemd/system/auto-update-mmdb.service`:

```ini
[Unit]
Description=Auto Update GeoLite2 MMDB
After=network-online.target
Wants=network-online.target

[Service]
Type=oneshot
ExecStart=/usr/local/bin/auto-update-mmdb
```

Create a systemd timer file at `/etc/systemd/system/auto-update-mmdb.timer`:

```ini
[Unit]
Description=Auto Update GeoLite2 MMDB Daily

[Timer]
OnCalendar=daily
Persistent=true

[Install]
WantedBy=timers.target
```

Enable and start the timer:

```bash
sudo systemctl daemon-reload
sudo systemctl enable auto-update-mmdb.timer
sudo systemctl start auto-update-mmdb.timer
```

## Generated Files

The tool generates the following files:

- `/usr/share/GeoIP/GeoLite2-Country.mmdb` - Downloaded MMDB file
- `/etc/nftables.d/cn4.nft` - IPv4 address set for China
- `/etc/nftables.d/cn6.nft` - IPv6 address set for China

## Usage Example

### Block China Traffic on Specific Port

This example shows how to block inbound traffic from China on port 2333.

Edit `/etc/nftables.conf`:

```nft
#!/usr/sbin/nft -f

# Clear existing rules
flush ruleset

table inet filter {

    #
    # Load China IPv4/IPv6 address sets generated from GeoLite2-Country.mmdb
    # These files are generated by: /usr/local/bin/auto-update-mmdb
    #
    include "/etc/nftables.d/cn4.nft"
    include "/etc/nftables.d/cn6.nft"

    #
    # Main input chain
    #
    chain input {
        type filter hook input priority 0;

        # Allow loopback traffic
        iifname "lo" accept

        # Allow established or related connections
        ct state established,related accept

        #
        # Block traffic from China (CN) specifically for TCP/UDP port 2333
        #
        tcp dport 2333 ip saddr @cn4 drop
        udp dport 2333 ip saddr @cn4 drop

        tcp dport 2333 ip6 saddr @cn6 drop
        udp dport 2333 ip6 saddr @cn6 drop

        #
        # Default policy: accept
        # (Modify here if you want a default-drop firewall)
        #
        accept
    }
}
```

Apply the configuration:

```bash
sudo systemctl restart nftables
```

### Other Use Cases

#### Block China Traffic on All Ports

```nft
chain input {
    type filter hook input priority 0;

    iifname "lo" accept
    ct state established,related accept

    # Drop all traffic from China
    ip saddr @cn4 drop
    ip6 saddr @cn6 drop

    accept
}
```

#### Allow Only China Traffic

```nft
chain input {
    type filter hook input priority 0;

    iifname "lo" accept
    ct state established,related accept

    # Accept traffic from China
    ip saddr @cn4 accept
    ip6 saddr @cn6 accept

    # Drop everything else
    drop
}
```

#### Block China Traffic on Multiple Ports

```nft
chain input {
    type filter hook input priority 0;

    iifname "lo" accept
    ct state established,related accept

    # Block CN traffic on specific ports
    tcp dport { 80, 443, 8080, 8443 } ip saddr @cn4 drop
    tcp dport { 80, 443, 8080, 8443 } ip6 saddr @cn6 drop

    accept
}
```

## Directory Structure

Ensure the following directories exist:

```bash
sudo mkdir -p /usr/share/GeoIP
sudo mkdir -p /etc/nftables.d
```

## Requirements

- Go 1.21 or later
- nftables
- Root privileges (for writing to `/usr/share/GeoIP` and `/etc/nftables.d`)

## How It Works

1. Fetches the latest release metadata from GitHub API
2. Downloads the GeoLite2-Country.mmdb file
3. Replaces the existing MMDB at `/usr/share/GeoIP/GeoLite2-Country.mmdb`
4. Parses the MMDB to extract all networks associated with China (ISO code: CN)
5. Generates nftables set files in the format:
   ```nft
   set cn4 {
       type ipv4_addr
       flags interval
       elements = {
           1.0.1.0/24,
           1.0.2.0/23,
           ...
       }
   }
   ```
6. Reloads nftables to apply the updated sets

## License

MIT

## Credits

- GeoLite2 data provided by [P3TERX/GeoLite.mmdb](https://github.com/P3TERX/GeoLite.mmdb)
- MMDB reader library: [oschwald/maxminddb-golang](https://github.com/oschwald/maxminddb-golang)
